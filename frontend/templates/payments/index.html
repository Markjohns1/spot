{% extends "base.html" %}

{% block title %}Payments - The Spot{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Payments Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Payment Recording</h1>
                    <p class="text-muted mb-0">Record and manage customer payments</p>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="refreshPayments()" class="btn btn-outline-primary" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span class="d-none d-md-inline ms-2">Refresh</span>
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-filter"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('all')">All Payments</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('cash')">Cash Only</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('mpesa')">M-Pesa Only</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('airtel')">Airtel Only</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('card')">Card Only</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('today')">Today Only</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('week')">This Week</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterPayments('unpaid')">Unpaid Orders</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Summary -->
    <div class="row g-2 mb-4 d-lg-none">
        <div class="col-6">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center p-2">
                    <div class="h4 mb-0" id="mobileDailyTotal">KES 0</div>
                    <small>Today's Total</small>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center p-2">
                    <div class="h4 mb-0" id="mobilePaymentCount">0</div>
                    <small>Transactions</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Payment -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cash-stack me-2"></i>
                        Quick Payment Recording
                    </h5>
                </div>
                <div class="card-body">
                    <form id="quickPaymentForm" class="row g-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Order Selection -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="orderSearch" class="form-label">Search Order #</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="orderSearch"
                                           name="order_number" placeholder="ORD-YYYYMMDD-NNN"
                                           autocomplete="off">
                                    <button class="btn btn-outline-light" type="button" onclick="searchOrder()">
                                        Find
                                    </button>
                                </div>
                                <div id="orderSearchResults" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Amount -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="quickAmount" class="form-label">Amount (KES)</label>
                                <input type="number" class="form-control form-control-lg" id="quickAmount"
                                       name="amount" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="quickMethod" class="form-label">Method</label>
                                <select class="form-select form-select-lg" id="quickMethod" name="payment_method" required>
                                    <option value="">Select Method</option>
                                    <option value="cash">Cash</option>
                                    <option value="mpesa">M-Pesa</option>
                                    <option value="airtel">Airtel Money</option>
                                    <option value="card">Card</option>
                                </select>
                            </div>
                        </div>

                        <!-- Reference -->
                        <div class="col-md-2">
                            <div class="form-group" id="quickReferenceGroup">
                                <label for="quickReference" class="form-label">Reference</label>
                                <input type="text" class="form-control form-control-lg" id="quickReference"
                                       name="transaction_reference" placeholder="Transaction ID">
                            </div>
                        </div>

                        <!-- Action -->
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-cash-stack"></i>
                                        Record
                                    </button>
                                    <button type="button" class="btn btn-outline-light" onclick="clearQuickForm()">
                                        <i class="bi bi-x"></i>
                                        Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Calculator Display -->
                    <div class="row mt-3" id="calculatorDisplay" style="display: none;">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 mb-0 text-primary" id="orderTotal">KES 0</div>
                                            <small>Order Total</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 mb-0 text-success" id="amountPaid">KES 0</div>
                                            <small>Amount Paid</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 mb-0 text-warning" id="balanceDue">KES 0</div>
                                            <small>Balance Due</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 mb-0 text-info" id="changeAmount">KES 0</div>
                                            <small>Change</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Summary (Desktop) -->
    <div class="row mb-4 d-none d-lg-flex">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Today's Payment Summary
                        <span class="badge bg-primary ms-2" id="todayDate">{{ now.strftime('%d %b %Y') }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="dailySummary">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h3 text-success mb-0">KES 0</div>
                                <small class="text-muted">Total Collected</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h3 text-primary mb-0">0</div>
                                <small class="text-muted">Total Transactions</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <div class="h3 text-info mb-0">Method Breakdown</div>
                                <div id="methodBreakdown" class="mt-2">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payments List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-receipt me-2"></i>
                        Recent Payments
                        <span class="badge bg-secondary ms-2" id="paymentCount">0</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <button onclick="exportPayments()" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-download"></i>
                            <span class="d-none d-md-inline ms-2">Export</span>
                        </button>
                        <button onclick="printDailyReport()" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-printer"></i>
                            <span class="d-none d-md-inline ms-2">Print Report</span>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Order #</th>
                                    <th class="d-none d-md-table-cell">Customer</th>
                                    <th class="d-none d-md-table-cell">Vehicle</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th class="d-none d-lg-table-cell">Reference</th>
                                    <th class="d-none d-md-table-cell">Staff</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTable">
                                {% if payments %}
                                    {% for payment in payments %}
                                    <tr class="payment-row" data-payment-id="{{ payment.id }}"
                                        data-method="{{ payment.payment_method }}">
                                        <td>
                                            <div class="text-nowrap">
                                                {{ payment.created_at.strftime('%d %b %Y') }}<br>
                                                <small class="text-muted">{{ payment.created_at.strftime('%H:%M %p') }}</small>
                                            </div>
                                        </td>
                                        <td class="fw-medium">
                                            {% if payment.order %}
                                                <a href="{{ url_for('main.view_order', order_id=payment.order_id) }}"
                                                   class="text-decoration-none">
                                                    {{ payment.order.order_number }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if payment.order and payment.order.customer %}
                                                {% if payment.order.customer.name %}
                                                    <div>{{ payment.order.customer.name }}</div>
                                                    <small class="text-muted">{{ payment.order.customer.phone_number }}</small>
                                                {% else %}
                                                    {{ payment.order.customer.phone_number }}
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if payment.order and payment.order.vehicle %}
                                                {{ payment.order.vehicle.registration_number }}
                                                {% if payment.order.vehicle.make %}
                                                    <small class="text-muted">({{ payment.order.vehicle.make }})</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-success">KES {{ "{:,}".format(payment.amount|float) }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if payment.payment_method == 'cash' else 'info' if payment.payment_method == 'mpesa' else 'warning' if payment.payment_method == 'airtel' else 'secondary' }}">
                                                {{ payment.get_payment_method_display_name() }}
                                            </span>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            {% if payment.transaction_reference %}
                                                {{ payment.transaction_reference }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if payment.recorder %}
                                                {{ payment.recorder.full_name }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewPaymentReceipt({{ payment.id }})"
                                                        title="View Receipt">
                                                    <i class="bi bi-receipt"></i>
                                                </button>
                                                {% if current_user.role in ['admin', 'manager'] %}
                                                <button class="btn btn-outline-warning" onclick="editPayment({{ payment.id }})"
                                                        title="Edit Payment">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deletePayment({{ payment.id }})"
                                                        title="Delete Payment">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="bi bi-cash-stack text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2 mb-0">No payments recorded today</p>
                                        <small class="text-muted">Payments will appear here once recorded</small>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if payments and payments.pages > 1 %}
                    <div class="card-footer bg-transparent border-0">
                        <nav>
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                {% if payments.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ payments.prev_num }}">Previous</a>
                                </li>
                                {% endif %}

                                {% for page_num in payments.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != payments.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}

                                {% if payments.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ payments.next_num }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Receipt Modal -->
<div class="modal fade" id="paymentReceiptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-receipt me-2"></i>
                    Payment Receipt
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="paymentReceiptContent">
                <!-- Content will be loaded via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">
                    <i class="bi bi-printer me-2"></i>
                    Print Receipt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Payment Modal -->
<div class="modal fade" id="editPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>
                    Edit Payment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPaymentForm">
                    <input type="hidden" id="editPaymentId" name="payment_id">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="form-group mb-3">
                        <label for="editAmount" class="form-label">Amount (KES)</label>
                        <input type="number" class="form-control form-control-lg" id="editAmount"
                               name="amount" step="0.01" min="0" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="editMethod" class="form-label">Payment Method</label>
                        <select class="form-select form-select-lg" id="editMethod" name="payment_method" required>
                            <option value="cash">Cash</option>
                            <option value="mpesa">M-Pesa</option>
                            <option value="airtel">Airtel Money</option>
                            <option value="card">Card</option>
                        </select>
                    </div>

                    <div class="form-group mb-3" id="editReferenceGroup">
                        <label for="editReference" class="form-label">Transaction Reference</label>
                        <input type="text" class="form-control" id="editReference" name="transaction_reference"
                               placeholder="Enter transaction ID/number">
                    </div>

                    <div class="form-group mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"
                                  placeholder="Any notes about this payment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="updatePayment()">
                    <i class="bi bi-check-circle me-2"></i>
                    Update Payment
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentFilter = 'all';
let currentOrderData = null;

// Initialize payments page
document.addEventListener('DOMContentLoaded', function() {
    initializePayments();
    loadDailySummary();
    setupPaymentForm();
});

function initializePayments() {
    // Setup method change handler
    document.getElementById('quickMethod')?.addEventListener('change', handleMethodChange);
    document.getElementById('editMethod')?.addEventListener('change', handleEditMethodChange);

    // Setup amount change handler for calculator
    document.getElementById('quickAmount')?.addEventListener('input', updateCalculator);

    // Initialize payment count
    updatePaymentCount();
}

function setupPaymentForm() {
    const form = document.getElementById('quickPaymentForm');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        recordQuickPayment();
    });

    // Setup order search
    const orderSearch = document.getElementById('orderSearch');
    if (orderSearch) {
        orderSearch.addEventListener('input', debounceOrderSearch);
        orderSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchOrder();
            }
        });
    }
}

function handleMethodChange() {
    const method = document.getElementById('quickMethod').value;
    const referenceGroup = document.getElementById('quickReferenceGroup');

    const needsReference = ['mpesa', 'airtel', 'card'].includes(method);

    if (needsReference) {
        referenceGroup.style.display = 'block';
        document.getElementById('quickReference').required = true;
    } else {
        referenceGroup.style.display = 'none';
        document.getElementById('quickReference').required = false;
        document.getElementById('quickReference').value = '';
    }

    updateCalculator();
}

function handleEditMethodChange() {
    const method = document.getElementById('editMethod').value;
    const referenceGroup = document.getElementById('editReferenceGroup');

    const needsReference = ['mpesa', 'airtel', 'card'].includes(method);

    if (needsReference) {
        referenceGroup.style.display = 'block';
        document.getElementById('editReference').required = true;
    } else {
        referenceGroup.style.display = 'none';
        document.getElementById('editReference').required = false;
        document.getElementById('editReference').value = '';
    }
}

function updateCalculator() {
    if (!currentOrderData) return;

    const amount = parseFloat(document.getElementById('quickAmount').value) || 0;
    const method = document.getElementById('quickMethod').value;
    const calculatorDisplay = document.getElementById('calculatorDisplay');

    if (amount > 0 && currentOrderData.total_amount > 0) {
        calculatorDisplay.style.display = 'block';

        const orderTotal = currentOrderData.total_amount;
        const previousPaid = currentOrderData.amount_paid || 0;
        const totalPaid = previousPaid + amount;
        const balanceDue = Math.max(0, orderTotal - totalPaid);

        document.getElementById('orderTotal').textContent = `KES ${orderTotal.toLocaleString()}`;
        document.getElementById('amountPaid').textContent = `KES ${totalPaid.toLocaleString()}`;
        document.getElementById('balanceDue').textContent = `KES ${balanceDue.toLocaleString()}`;

        // Calculate change for cash payments
        if (method === 'cash' && amount > balanceDue) {
            const change = amount - balanceDue;
            document.getElementById('changeAmount').textContent = `KES ${change.toLocaleString()}`;
        } else {
            document.getElementById('changeAmount').textContent = 'KES 0';
        }
    } else {
        calculatorDisplay.style.display = 'none';
    }
}

function debounceOrderSearch() {
    clearTimeout(window.orderSearchTimeout);
    window.orderSearchTimeout = setTimeout(searchOrder, 500);
}

function searchOrder() {
    const query = document.getElementById('orderSearch').value.trim();

    if (query.length < 3) {
        document.getElementById('orderSearchResults').innerHTML = '';
        currentOrderData = null;
        updateCalculator();
        return;
    }

    fetch(`/api/orders?search=${query}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.orders.length > 0) {
                showOrderSearchResults(data.data.orders);
            } else {
                document.getElementById('orderSearchResults').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No orders found with "${query}"
                    </div>
                `;
                currentOrderData = null;
                updateCalculator();
            }
        })
        .catch(error => {
            console.error('Order search error:', error);
            SpotApp.showToast('Search failed. Please try again.', 'error');
        });
}

function showOrderSearchResults(orders) {
    const resultsDiv = document.getElementById('orderSearchResults');

    if (orders.length === 0) {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                No orders found
            </div>
        `;
        return;
    }

    let html = '<div class="list-group">';
    orders.forEach(order => {
        const statusBadge = getStatusBadge(order.status);
        html += `
            <div class="list-group-item list-group-item-action cursor-pointer"
                 onclick="selectOrder(${order.id}, ${JSON.stringify(order).replace(/"/g, '&quot;')})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-medium">${order.order_number}</div>
                        <small class="text-muted">
                            ${order.customer ? (order.customer.name || order.customer.phone_number) : 'Walk-in'}
                        </small>
                    </div>
                    <div class="text-end">
                        ${statusBadge}
                        <div class="text-success fw-bold">KES ${order.total_amount.toLocaleString()}</div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    resultsDiv.innerHTML = html;
}

function selectOrder(orderId, order) {
    currentOrderData = order;

    // Update form
    document.getElementById('orderSearch').value = order.order_number;
    document.getElementById('orderSearchResults').innerHTML = '';

    // Auto-fill amount if unpaid or partially paid
    const balanceDue = order.total_amount - (order.amount_paid || 0);
    if (balanceDue > 0) {
        document.getElementById('quickAmount').value = balanceDue;
    } else {
        document.getElementById('quickAmount').value = order.total_amount;
    }

    // Focus on amount
    document.getElementById('quickAmount').focus();

    updateCalculator();
}

function recordQuickPayment() {
    if (!currentOrderData) {
        alert('Please select an order first');
        return;
    }

    const form = document.getElementById('quickPaymentForm');
    const formData = new FormData(form);

    const paymentData = {
        order_id: currentOrderData.id,
        amount: parseFloat(formData.get('amount')),
        payment_method: formData.get('payment_method'),
        transaction_reference: formData.get('transaction_reference'),
        notes: `Quick payment via payments page`
    };

    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise rotating"></i> Recording...';
    submitBtn.disabled = true;

    fetch('/api/payments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SpotApp.showToast('Payment recorded successfully', 'success');
            clearQuickForm();
            refreshPayments();
            loadDailySummary();
        } else {
            SpotApp.showToast(data.error.message || 'Failed to record payment', 'error');
        }
    })
    .catch(error => {
        console.error('Payment recording error:', error);
        SpotApp.showToast('Failed to record payment. Please try again.', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function clearQuickForm() {
    document.getElementById('quickPaymentForm').reset();
    document.getElementById('orderSearch').value = '';
    document.getElementById('orderSearchResults').innerHTML = '';
    document.getElementById('calculatorDisplay').style.display = 'none';
    currentOrderData = null;

    // Remove validation classes
    document.getElementById('quickPaymentForm').classList.remove('was-validated');
}

function refreshPayments() {
    const refreshBtn = document.getElementById('refreshBtn');

    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise rotating"></i> <span class="d-none d-md-inline ms-2">Refreshing...</span>';
    refreshBtn.disabled = true;

    window.location.reload(); // Simple reload for now
}

function updatePaymentCount() {
    const count = document.querySelectorAll('.payment-row').length;
    document.getElementById('paymentCount').textContent = count;

    const mobileCount = document.getElementById('mobilePaymentCount');
    if (mobileCount) {
        mobileCount.textContent = count;
    }
}

function loadDailySummary() {
    fetch('/api/payments/daily')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDailySummaryDisplay(data.data);
            }
        })
        .catch(error => {
            console.error('Daily summary error:', error);
        });
}

function updateDailySummaryDisplay(summary) {
    // Update desktop summary
    const totalCollected = summary.total_collected || 0;
    const paymentCount = summary.payment_count || 0;

    // Find the total collected element
    const totalElement = document.querySelector('#dailySummary .h3.text-success');
    if (totalElement) {
        totalElement.textContent = `KES ${totalCollected.toLocaleString()}`;
    }

    const countElement = document.querySelector('#dailySummary .h3.text-primary');
    if (countElement) {
        countElement.textContent = paymentCount;
    }

    // Update mobile summary
    const mobileTotal = document.getElementById('mobileDailyTotal');
    if (mobileTotal) {
        mobileTotal.textContent = `KES ${totalCollected.toLocaleString()}`;
    }

    // Update method breakdown
    const breakdownElement = document.getElementById('methodBreakdown');
    if (breakdownElement && summary.by_method) {
        let html = '<div class="d-flex flex-wrap gap-2 justify-content-center">';
        summary.by_method.forEach(method => {
            const badgeClass = getMethodBadgeClass(method.method);
            html += `
                <span class="badge ${badgeClass}">
                    ${method.method_display}: ${method.count} (KES ${method.total.toLocaleString()})
                </span>
            `;
        });
        html += '</div>';
        breakdownElement.innerHTML = html;
    }
}

function getMethodBadgeClass(method) {
    const classes = {
        'cash': 'bg-success',
        'mpesa': 'bg-info',
        'airtel': 'bg-warning',
        'card': 'bg-secondary'
    };
    return classes[method] || 'bg-primary';
}

function getStatusBadge(status) {
    const classes = {
        'pending': 'bg-warning',
        'in_progress': 'bg-info',
        'completed': 'bg-success',
        'cancelled': 'bg-danger'
    };
    const labels = {
        'pending': 'Pending',
        'in_progress': 'In Progress',
        'completed': 'Completed',
        'cancelled': 'Cancelled'
    };

    return `<span class="badge ${classes[status] || 'bg-secondary'}">${labels[status] || status}</span>`;
}

function filterPayments(filter) {
    currentFilter = filter;

    const rows = document.querySelectorAll('.payment-row');
    let visibleCount = 0;

    rows.forEach(row => {
        let show = false;

        switch (filter) {
            case 'all':
                show = true;
                break;
            case 'cash':
            case 'mpesa':
            case 'airtel':
            case 'card':
                show = row.dataset.method === filter;
                break;
            case 'today':
                // Would need date comparison
                show = true;
                break;
            case 'week':
                // Would need date comparison
                show = true;
                break;
            case 'unpaid':
                // Would need unpaid status check
                show = false;
                break;
        }

        row.style.display = show ? 'table-row' : 'none';
        if (show) visibleCount++;
    });

    // Update count
    document.getElementById('paymentCount').textContent = visibleCount;
}

function viewPaymentReceipt(paymentId) {
    fetch(`/api/payments/${paymentId}/receipt`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPaymentReceiptModal(data.data.receipt);
            } else {
                SpotApp.showToast('Failed to load receipt', 'error');
            }
        })
        .catch(error => {
            console.error('Receipt loading error:', error);
            SpotApp.showToast('Error loading receipt', 'error');
        });
}

function showPaymentReceiptModal(receipt) {
    const content = document.getElementById('paymentReceiptContent');

    let html = `
        <div class="text-center mb-4">
            <h4 class="text-success">Payment Receipt</h4>
            <p class="text-muted mb-0">Transaction #${receipt.payment_id}</p>
        </div>

        <table class="table table-borderless">
            <tr>
                <td><strong>Order Number:</strong></td>
                <td>${receipt.order_number || 'N/A'}</td>
            </tr>
            <tr>
                <td><strong>Customer:</strong></td>
                <td>${receipt.customer_name || receipt.customer_phone || 'N/A'}</td>
            </tr>
            <tr>
                <td><strong>Vehicle:</strong></td>
                <td>${receipt.vehicle_info || 'N/A'}</td>
            </tr>
            <tr>
                <td><strong>Amount Paid:</strong></td>
                <td class="text-success fw-bold">KES ${receipt.amount.toLocaleString()}</td>
            </tr>
            <tr>
                <td><strong>Payment Method:</strong></td>
                <td>${receipt.payment_method}</td>
            </tr>
            ${receipt.transaction_reference ? `
            <tr>
                <td><strong>Transaction Ref:</strong></td>
                <td>${receipt.transaction_reference}</td>
            </tr>
            ` : ''}
            <tr>
                <td><strong>Payment Date:</strong></td>
                <td>${receipt.paid_at}</td>
            </tr>
            <tr>
                <td><strong>Recorded By:</strong></td>
                <td>${receipt.recorded_by || 'N/A'}</td>
            </tr>
        </table>

        ${receipt.balance_due > 0 ? `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Balance Due: KES ${receipt.balance_due.toLocaleString()}
            </div>
        ` : ''}
    `;

    content.innerHTML = html;

    const modal = new bootstrap.Modal(document.getElementById('paymentReceiptModal'));
    modal.show();
}

function editPayment(paymentId) {
    fetch(`/api/payments/${paymentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditPaymentModal(data.data.payment);
            } else {
                SpotApp.showToast('Failed to load payment', 'error');
            }
        })
        .catch(error => {
            console.error('Payment loading error:', error);
            SpotApp.showToast('Error loading payment', 'error');
        });
}

function showEditPaymentModal(payment) {
    // Populate form
    document.getElementById('editPaymentId').value = payment.id;
    document.getElementById('editAmount').value = payment.amount;
    document.getElementById('editMethod').value = payment.payment_method;
    document.getElementById('editReference').value = payment.transaction_reference || '';
    document.getElementById('editNotes').value = payment.notes || '';

    // Handle method change
    handleEditMethodChange();

    const modal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
    modal.show();
}

function updatePayment() {
    const form = document.getElementById('editPaymentForm');
    const formData = new FormData(form);

    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    const paymentId = formData.get('payment_id');
    const paymentData = {
        amount: parseFloat(formData.get('amount')),
        payment_method: formData.get('payment_method'),
        transaction_reference: formData.get('transaction_reference'),
        notes: formData.get('notes')
    };

    fetch(`/api/payments/${paymentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SpotApp.showToast('Payment updated successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editPaymentModal')).hide();
            refreshPayments();
            loadDailySummary();
        } else {
            SpotApp.showToast(data.error.message || 'Failed to update payment', 'error');
        }
    })
    .catch(error => {
        console.error('Payment update error:', error);
        SpotApp.showToast('Failed to update payment. Please try again.', 'error');
    });
}

function deletePayment(paymentId) {
    if (!confirm('Are you sure you want to delete this payment? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/payments/${paymentId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SpotApp.showToast('Payment deleted successfully', 'success');
            refreshPayments();
            loadDailySummary();
        } else {
            SpotApp.showToast(data.error.message || 'Failed to delete payment', 'error');
        }
    })
    .catch(error => {
        console.error('Payment deletion error:', error);
        SpotApp.showToast('Failed to delete payment. Please try again.', 'error');
    });
}

function exportPayments() {
    window.print();
}

function printDailyReport() {
    window.print();
}

function printReceipt() {
    window.print();
}

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
           document.querySelector('input[name="csrf_token"]')?.value || '';
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + P for quick payment focus
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        document.getElementById('orderSearch')?.focus();
    }

    // Ctrl/Cmd + R to refresh
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        refreshPayments();
    }

    // Ctrl/Cmd + N for new order
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        window.location.href = '/orders/new';
    }

    // F5 to refresh
    if (e.key === 'F5') {
        e.preventDefault();
        refreshPayments();
    }

    // Escape to clear form
    if (e.key === 'Escape') {
        clearQuickForm();
    }
});

// Auto-refresh every 2 minutes for payments
setInterval(() => {
    if (document.visibilityState === 'visible') {
        loadDailySummary();
    }
}, 120000);
</script>

<style>
/* Payment-specific styles */
.payment-row:hover {
    background-color: #f8f9fa;
}

.method-badge {
    font-size: 0.8rem;
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}

.order-search-results .list-group-item {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.order-search-results .list-group-item:hover {
    background-color: #e9ecef;
}

.calculator-display {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mobile optimizations */
@media (max-width: 767.98px) {
    .table-responsive {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .table th,
    .table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.875rem;
    }

    .btn-group-sm {
        flex-direction: column;
    }

    .form-control-lg {
        font-size: 1rem;
        padding: 0.5rem;
    }
}

/* Print styles */
@media print {
    .navbar,
    .btn,
    .modal,
    .pagination,
    .alert {
        display: none !important;
    }

    .card {
        box-shadow: none;
        border: 1px solid #000;
        margin-bottom: 1rem;
    }

    .table {
        font-size: 10pt;
    }

    .payment-row {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %}